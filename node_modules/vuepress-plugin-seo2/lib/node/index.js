import{chalk as v,fs as $}from"@vuepress/utils";import{Logger as J,md2text as R,isAbsoluteUrl as D,isUrl as O,getAuthor as P,getDate as _,stripTags as F}from"vuepress-shared/node";import{isLinkHttp as M,removeEndingSlash as y,removeLeadingSlash as q}from"@vuepress/shared";import W from"gray-matter";const p=new J("vuepress-plugin-seo2"),C=(t,e)=>Object.entries(e).map(([a,n])=>({localePath:a,lang:n.lang})).filter(a=>typeof a.lang=="string"&&a.lang!==t),E=({frontmatter:t},{hostname:e},{options:{base:a}})=>{const{banner:n,cover:o}=t;if(n){if(D(n))return S(e,a,n);if(O(n))return n}if(o){if(D(o))return S(e,a,o);if(O(o))return o}return null},U=({content:t},{hostname:e},{options:{base:a}})=>{const n=/!\[.*?\]\((.*?)\)/giu.exec(t);return n?n.map(([,o])=>D(o)?S(e,a,o):O(o)?o:null).filter(o=>o!==null):[]},S=(t,e,a)=>`${M(t)?y(t):`https://${y(t)}`}${e}${q(a)}`,z=t=>R(W(t).content.trim().replace(/^# (.*)$/gm,"")).replace(/(?:\r?\n)+/g," ").replace(/ +/g," ").trim(),j=(t,e,a="",n="")=>{e in t&&(p.error(`"${v.magenta(e)}" is ${v.red("removed")}${n?`, please use ${v.magenta(n)} instead.`:" and no longer supported"}${a?`
${a}`:""}`),n||delete t[e])},K=t=>{j(t,"seo","","ogp"),j(t,"customMeta","","customHead")},Q=(t,e,a)=>{var n,o,i;const{isArticle:r=c=>Boolean(c.filePathRelative&&!c.frontmatter.home)}=e,{options:{base:d},siteData:s}=a,{frontmatter:{author:g,time:b,date:m=b,tag:u,tags:f=u},data:{git:h={}}}=t,l=((n=s.locales[t.pathLocale])==null?void 0:n.title)||s.title||((o=s.locales["/"])==null?void 0:o.title)||"",B=g===!1?[]:P(g||e.author),{updatedTime:x}=h,I=x?new Date(x).toISOString():"",G=Array.isArray(f)?f:typeof u=="string"?[u]:[],k=t.title,H=E(t,e,a),N=U(t,e,a),T=C(t.lang,s.locales);let w="";if(m instanceof Date)w=new Date(m).toISOString();else if(m){const c=_(m);c&&c.value&&(w=c.value.toISOString())}const A=H||N[0]||e.fallBackImage||"";return{"og:url":S(e.hostname,d,t.path),"og:site_name":l,"og:title":k,"og:description":t.frontmatter.description||"","og:type":r(t)?"article":"website","og:image":A,"og:updated_time":I,"og:locale":t.lang,"og:locale:alternate":T.map(({lang:c})=>c),...e.restrictions?{"og:restrictions:age":e.restrictions}:{},...e.twitterID?{"twitter:creator":e.twitterID}:{},...A?{"twitter:card":"summary_large_image","twitter:image:alt":k}:{},"article:author":(i=B[0])==null?void 0:i.name,"article:tag":G,"article:published_time":w,"article:modified_time":I}},V=(t,e,a)=>{const{isArticle:n=l=>Boolean(l.filePathRelative&&!l.frontmatter.home)}=e,{frontmatter:{author:o,time:i,date:r=i},data:{git:d={}}}=t,s=o===!1?[]:P(o||e.author),{updatedTime:g}=d,b=g?new Date(g).toISOString():"",m=t.title,u=E(t,e,a),f=U(t,e,a);let h="";if(r instanceof Date)h=new Date(r).toISOString();else if(r){const l=_(r);l&&l.value&&(h=l.value.toISOString())}return n(t)?{"@context":"https://schema.org","@type":"NewsArticle",headline:m,image:f.length?f:[u||e.fallBackImage||""],datePublished:h,dateModified:b,author:s.map(l=>({"@type":"Person",...l}))}:null},X=(t,e)=>typeof e.canonical=="function"?e.canonical(t):typeof e.canonical=="string"?`${y(e.canonical)}${t.path}`:null,Y=(t,{hostname:e},{options:a,siteData:n})=>C(t.lang,n.locales).map(({lang:o,localePath:i})=>({lang:o,path:S(e,a.base,`${i}${t.path.replace(t.pathLocale,"")}`)})),L=(t,{name:e,content:a,attribute:n=["article:","og:"].some(o=>e.startsWith(o))?"property":"name"})=>{a&&t.push(["meta",{[n]:e,content:a}])},Z=(t,e)=>{for(const a in e)switch(a){case"article:tag":e["article:tag"].forEach(n=>L(t,{name:"article:tag",content:n}));break;case"og:locale:alternate":e["og:locale:alternate"].forEach(n=>{n!==e["og:locale"]&&L(t,{name:"og:locale:alternate",content:n})});break;default:e[a]&&L(t,{name:a,content:e[a]})}},tt=(t,e)=>{e&&t.push(["script",{type:"application/ld+json"},JSON.stringify(e)])},et=(t,e)=>{e&&t.push(["link",{rel:"canonical",href:e}])},at=(t,e)=>{e.forEach(({lang:a,path:n})=>{t.push(["link",{rel:"alternate",hreflang:a.toLowerCase(),href:n}])})},nt=(t,e,a)=>{const n=t.frontmatter.head||[],o=Q(t,e,a),i=V(t,e,a),r=e.ogp?e.ogp(o,t,a):o,d=e.jsonLd?e.jsonLd(i,t,a):null,s=X(t,e),g=Y(t,e,a);Z(n,r),tt(n,d),et(n,s),at(n,g),e.customHead&&e.customHead(n,t,a),t.frontmatter.head=n},ot=async t=>{p.load("Generating robots.txt");const e=t.public("robots.txt");let a=$.existsSync(e)?await $.readFile(e,{encoding:"utf8"}):"";a&&!a.includes("User-agent")?(p.error(),p.update("robots.txt seems invalid!")):(a+=`
User-agent:*
Disallow:
`,await $.writeFile(t.dest("robots.txt"),a,{flag:"w"}),p.succeed())},rt=(t,e=!1)=>a=>{e&&K(t),a.env.isDebug&&p.info(`Options: ${t.toString()}`);const n={name:"vuepress-plugin-seo2"};return t.hostname?{...n,extendsPage:(o,i)=>{if(!o.frontmatter.description&&t.autoDescription!==!1){if(o.excerpt)o.frontmatter.description=F(o.excerpt).replace(/(?:\r?\n)+/g," ").replace(/ +/g," ").trim();else{const r=z(o.content);o.frontmatter.description=r.length>180?`${r.slice(0,177)}...`:r}o.data.autoDesc=!0}nt(o,t,i)},onGenerated:o=>ot(o.dir)}:(p.error(`Option ${v.magenta("hostname")} is required!`),n)};export{rt as seoPlugin};
//# sourceMappingURL=index.js.map
