{"version":3,"file":"index.js","sources":["../../src/node/utils.ts","../../src/node/compact/utils.ts","../../src/node/compact/convert.ts","../../src/node/generateSitemap.ts","../../src/node/plugin.ts"],"sourcesContent":["import { Logger } from \"vuepress-shared/node\";\n\nexport const logger = new Logger(\"vuepress-plugin-sitemap2\");\n","import { chalk } from \"@vuepress/utils\";\nimport { logger } from \"../utils.js\";\n\nexport interface DeprecatedLoggerOptions {\n  options: Record<string, unknown>;\n  deprecatedOption: string;\n  newOption: string;\n  msg?: string;\n  scope?: string;\n}\n\nexport const deprecatedLogger = ({\n  options,\n  deprecatedOption,\n  newOption,\n  msg = \"\",\n  scope = \"\",\n}: DeprecatedLoggerOptions): void => {\n  if (deprecatedOption in options) {\n    logger.warn(\n      `${chalk.magenta(deprecatedOption)} is ${chalk.yellow(\"deprecated\")}${\n        scope ? ` in ${scope}` : \"\"\n      }, please use \"${chalk.magenta(newOption)}\" instead.${\n        msg ? `\\n${msg}` : \"\"\n      }`\n    );\n\n    if (newOption.includes(\".\")) {\n      const keys = newOption.split(\".\");\n      let temp = options;\n\n      keys.forEach((key, index) => {\n        if (index !== keys.length - 1) {\n          // ensure level exists\n          temp[key] = temp[key] || {};\n\n          temp = temp[key] as Record<string, unknown>;\n        } else temp[key] = options[deprecatedOption];\n      });\n    } else options[newOption] = options[deprecatedOption];\n\n    delete options[deprecatedOption];\n  }\n};\n","import { deprecatedLogger } from \"./utils.js\";\nimport type { SitemapOptions } from \"../options.js\";\n\n/** @deprecated */\nexport const convertOptions = (\n  options: SitemapOptions & Record<string, unknown>\n): void => {\n  deprecatedLogger({\n    options,\n    deprecatedOption: \"urls\",\n    newOption: \"extraUrls\",\n  });\n  deprecatedLogger({\n    options,\n    deprecatedOption: \"exclude\",\n    newOption: \"excludeUrls\",\n  });\n  deprecatedLogger({\n    options,\n    deprecatedOption: \"outFile\",\n    newOption: \"sitemapFilename\",\n  });\n  deprecatedLogger({\n    options,\n    deprecatedOption: \"dateFormatter\",\n    newOption: \"modifyTimeGetter\",\n  });\n};\n","import {\n  isLinkHttp,\n  removeEndingSlash,\n  removeLeadingSlash,\n} from \"@vuepress/shared\";\nimport { chalk, fs } from \"@vuepress/utils\";\nimport { SitemapStream } from \"sitemap\";\nimport { logger } from \"./utils.js\";\n\nimport type { App, Page } from \"@vuepress/core\";\nimport type { GitData } from \"@vuepress/plugin-git\";\nimport type { ModifyTimeGetter, SitemapOptions } from \"./options.js\";\nimport type {\n  SitemapFrontmatterOption,\n  SitemapImageOption,\n  SitemapLinkOption,\n  SitemapNewsOption,\n  SitemapVideoOption,\n} from \"./typings/index.js\";\n\ninterface SitemapPageInfo {\n  lastmod?: string;\n  changefreq?: string;\n  priority?: number;\n  img?: SitemapImageOption[];\n  video?: SitemapVideoOption[];\n  links?: SitemapLinkOption[];\n  news?: SitemapNewsOption[];\n}\n\nconst reportedLocales: string[] = [];\n\nconst stripLocalePrefix = (\n  page: Page\n): {\n  // path of root locale\n  defaultPath: string;\n  // Locale path prefix of the page\n  pathLocale: string;\n} => ({\n  defaultPath: page.path.replace(page.pathLocale, \"/\"),\n  pathLocale: page.pathLocale,\n});\n\nconst generatePageMap = (\n  app: App,\n  options: SitemapOptions\n): Map<string, SitemapPageInfo> => {\n  const {\n    changefreq,\n    excludeUrls = [\"/404.html\"],\n    modifyTimeGetter = <ModifyTimeGetter>(\n      ((page: Page<{ git: GitData }>): string =>\n        page.data.git?.updatedTime\n          ? new Date(page.data.git.updatedTime).toISOString()\n          : \"\")\n    ),\n  } = options;\n\n  const {\n    pages,\n    options: { base, locales },\n  } = app;\n\n  const pageLocalesMap = pages.reduce(\n    (map, page) => {\n      const { defaultPath, pathLocale } = stripLocalePrefix(page);\n      const pathLocales = map.get(defaultPath) || [];\n\n      pathLocales.push(pathLocale);\n\n      return map.set(defaultPath, pathLocales);\n    },\n    // a map with keys of defaultPath and string[] value with pathLocales\n    new Map<string, string[]>()\n  );\n\n  const pagesMap = new Map<string, SitemapPageInfo>();\n\n  pages.forEach((page) => {\n    const frontmatterOptions: SitemapFrontmatterOption =\n      <SitemapFrontmatterOption>page.frontmatter[\"sitemap\"] || {};\n\n    const metaRobotTags = (page.frontmatter.head || []).find(\n      (head) => head[1][\"name\"] === \"robots\"\n    );\n\n    const excludePage = metaRobotTags\n      ? (<string>metaRobotTags[1][\"content\"] || \"\")\n          .split(/,/u)\n          .map((content) => content.trim())\n          .includes(\"noindex\")\n      : frontmatterOptions.exclude;\n\n    if (excludePage || excludeUrls.includes(page.path)) return;\n\n    const lastModifyTime = modifyTimeGetter(page);\n    const { defaultPath } = stripLocalePrefix(page);\n    const relatedLocales = pageLocalesMap.get(defaultPath) || [];\n\n    let links: SitemapLinkOption[] = [];\n\n    if (relatedLocales.length > 1) {\n      // warnings for missing `locale[path].lang` in debug mode\n      if (app.env.isDebug)\n        relatedLocales.forEach((localePrefix) => {\n          if (\n            !locales[localePrefix].lang &&\n            !reportedLocales.includes(localePrefix)\n          ) {\n            logger.warn(`'lang' option for ${localePrefix} is missing`);\n            reportedLocales.push(localePrefix);\n          }\n        });\n\n      links = relatedLocales.map((localePrefix) => ({\n        lang: locales[localePrefix]?.lang || \"en\",\n        url: `${base}${removeLeadingSlash(\n          defaultPath.replace(/^\\//u, localePrefix)\n        )}`,\n      }));\n    }\n\n    const sitemapInfo: SitemapPageInfo = {\n      ...(changefreq ? { changefreq } : {}),\n      links,\n      ...(lastModifyTime ? { lastmod: lastModifyTime } : {}),\n      ...frontmatterOptions,\n    };\n\n    // log sitemap info in debug mode\n    if (app.env.isDebug) {\n      logger.info(\n        `sitemap option for ${page.path}: ${JSON.stringify(\n          sitemapInfo,\n          null,\n          2\n        )}`\n      );\n    }\n\n    pagesMap.set(page.path, sitemapInfo);\n  });\n\n  return pagesMap;\n};\n\nexport const generateSiteMap = async (\n  app: App,\n  options: SitemapOptions\n): Promise<void> => {\n  const { extraUrls = [], xmlNameSpace: xmlns } = options;\n  const hostname = isLinkHttp(options.hostname)\n    ? removeEndingSlash(options.hostname)\n    : `https://${removeEndingSlash(options.hostname)}`;\n  const sitemapFilename = options.sitemapFilename\n    ? removeLeadingSlash(options.sitemapFilename)\n    : \"sitemap.xml\";\n  const {\n    dir,\n    options: { base },\n  } = app;\n\n  logger.load(`Generating sitemap to ${chalk.cyan(`/${sitemapFilename}`)}`);\n\n  await new Promise<void>((resolve) => {\n    const sitemap = new SitemapStream({\n      hostname,\n      ...(xmlns ? { xmlns } : {}),\n    });\n    const pagesMap = generatePageMap(app, options);\n    const sitemapXMLPath = dir.dest(sitemapFilename);\n    const writeStream = fs.createWriteStream(sitemapXMLPath);\n\n    sitemap.pipe(writeStream);\n\n    pagesMap.forEach((page, path) =>\n      sitemap.write({\n        url: `${base}${removeLeadingSlash(path)}`,\n        ...page,\n      })\n    );\n\n    extraUrls.forEach((item) =>\n      sitemap.write({ url: `${base}${removeLeadingSlash(item)}` })\n    );\n    sitemap.end(() => {\n      resolve();\n    });\n  });\n\n  logger.succeed();\n\n  const robotTxtPath = dir.dest(\"robots.txt\");\n\n  if (fs.existsSync(robotTxtPath)) {\n    logger.load(`Appended sitemap path to ${chalk.cyan(\"robots.txt\")}`);\n\n    const robotsTxt = await fs.readFile(robotTxtPath, { encoding: \"utf8\" });\n\n    const newRobotsTxtContent = `${robotsTxt.replace(\n      /^Sitemap: .*$/u,\n      \"\"\n    )}\\nSitemap: ${hostname}${base}${sitemapFilename}\\n`;\n\n    await fs.writeFile(robotTxtPath, newRobotsTxtContent, { flag: \"w\" });\n\n    logger.succeed();\n  }\n};\n","import { chalk } from \"@vuepress/utils\";\nimport { convertOptions } from \"./compact/index.js\";\nimport { generateSiteMap } from \"./generateSitemap.js\";\nimport { logger } from \"./utils.js\";\n\nimport type { PluginObject, PluginFunction } from \"@vuepress/core\";\nimport type { SitemapOptions } from \"./options.js\";\n\nexport const sitemapPlugin =\n  (options: SitemapOptions, legacy = false): PluginFunction =>\n  (app) => {\n    // TODO: Remove this in v2 stable\n    if (legacy)\n      convertOptions(options as SitemapOptions & Record<string, unknown>);\n    if (app.env.isDebug) logger.info(`Options: ${options.toString()}`);\n\n    const plugin: PluginObject = {\n      name: \"vuepress-plugin-sitemap2\",\n    };\n\n    if (!options.hostname) {\n      logger.error(`Option ${chalk.magenta(\"hostname\")} is required!`);\n\n      return plugin;\n    }\n\n    return {\n      ...plugin,\n\n      onGenerated: (app): Promise<void> => generateSiteMap(app, options),\n    };\n  };\n"],"names":["logger","Logger","deprecatedLogger","options","deprecatedOption","newOption","msg","scope","chalk","keys","temp","key","index","convertOptions","reportedLocales","stripLocalePrefix","page","generatePageMap","app","changefreq","excludeUrls","modifyTimeGetter","_a","pages","base","locales","pageLocalesMap","map","defaultPath","pathLocale","pathLocales","pagesMap","frontmatterOptions","metaRobotTags","head","content","lastModifyTime","relatedLocales","links","localePrefix","removeLeadingSlash","sitemapInfo","generateSiteMap","extraUrls","xmlns","hostname","isLinkHttp","removeEndingSlash","sitemapFilename","dir","resolve","sitemap","SitemapStream","sitemapXMLPath","writeStream","fs","path","item","robotTxtPath","newRobotsTxtContent","sitemapPlugin","legacy","plugin"],"mappings":"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"}